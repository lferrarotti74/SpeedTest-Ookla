name: Build and Publish (Caller)

# This workflow calls the reusable template in this repo and mirrors
# the original triggers, including paths-ignore and pull_request handling.

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      # Documentation files
      - '*.md'
      - 'docs/**'
      - '.github/**/*.md'

      # License and legal files
      - 'LICENSE*'
      - 'COPYING*'
      - 'COPYRIGHT*'

      # Git and GitHub specific files
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
      - '.github/dependabot.yml'
      - '.github/CODEOWNERS'

      # Editor and IDE files
      - '.vscode/**'
      - '.idea/**'
      - '*.swp'
      - '*.swo'
      - '*~'

      # Package manager files that don't affect builds
      - '.npmignore'
      - '.dockerignore'
      - '.eslintignore'
      - '.prettierignore'

      # CI/CD configuration for other systems
      - '.travis.yml'
      - '.circleci/**'
      - 'Jenkinsfile'
      - '.gitlab-ci.yml'

      # Common non-code files
      - '*.txt'
      - 'CHANGELOG*'
      - 'CONTRIBUTING*'
      - 'AUTHORS*'
      - 'MAINTAINERS*'

  pull_request:
    types: [ opened, synchronize, reopened ]
    paths-ignore:
      # Documentation files
      - '*.md'
      - 'docs/**'
      - '.github/**/*.md'

      # License and legal files
      - 'LICENSE*'
      - 'COPYING*'
      - 'COPYRIGHT*'

      # Git and GitHub specific files
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
      - '.github/dependabot.yml'
      - '.github/CODEOWNERS'

      # Editor and IDE files
      - '.vscode/**'
      - '.idea/**'
      - '*.swp'
      - '*.swo'
      - '*~'

      # Package manager files that don't affect builds
      - '.npmignore'
      - '.dockerignore'
      - '.eslintignore'
      - '.prettierignore'

      # CI/CD configuration for other systems
      - '.travis.yml'
      - '.circleci/**'
      - 'Jenkinsfile'
      - '.gitlab-ci.yml'

      # Common non-code files
      - '*.txt'
      - 'CHANGELOG*'
      - 'CONTRIBUTING*'
      - 'AUTHORS*'
      - 'MAINTAINERS*'

  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"  # daily at 03:00 UTC

# Token permissions required by the reusable workflow
permissions:
  contents: write           # needed for digest update job in the reusable workflow
  packages: write           # GHCR publishing via github.token
  actions: write            # allows patching repo variables via API
  security-events: write    # enables SARIF upload in security scan
  pull-requests: write      # ADD THIS - needed for SonarQube PR decoration

jobs:
  # Non-PR builds and publishes
  build-and-publish:
    if: github.event_name != 'pull_request'
    uses: lferrarotti74/github-workflows-templates/.github/workflows/build-extended.yml@25ec21c085efd79c053b177423a4ff2bbdc36bb1
    permissions:
      contents: write
      packages: write
      actions: write
      security-events: write
      pull-requests: write
    with:
      image_name: speedtest-ookla
      arch_list: ${{ vars.IMAGE_ARCHS }}                     # e.g. linux/amd64,linux/i386,linux/arm/v7,linux/arm64
      enable_push: ${{ vars.ENABLE_PUSH == 'true' }}         # uses your repo variable
      env_file_path: env/.env                                # optional; falls back to Git SHA if missing
      version_var_name: SPEEDTEST_VERSION                    # optional; used if present in env file
      enable_ghcr: true                                      # publish to GHCR in addition to Docker Hub
      enable_security_scan: true                             # run Trivy and upload SARIF
      enable_base_update_detection: true                     # only builds on schedule when Alpine base changes
      enable_sonar_scan: true                               # set true and configure secrets to enable sonar
      sonar_project_key: "lferrarotti74_SpeedTest-Ookla"
      sonar_organization: "lferrarotti74"
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      REPO_TOKEN: ${{ secrets.REPO_TOKEN }}

  # PR validation for regular users (with SonarQube)
  pr-validate:
    if: github.event_name == 'pull_request' && github.actor != 'dependabot[bot]'
    uses: lferrarotti74/github-workflows-templates/.github/workflows/build-extended.yml@25ec21c085efd79c053b177423a4ff2bbdc36bb1
    with:
      image_name: speedtest-ookla
      arch_list: linux/amd64,linux/arm64                      # faster validation set; adjust if you need full matrix
      enable_push: false                                      # donâ€™t push on PRs
      env_file_path: env/.env
      version_var_name: SPEEDTEST_VERSION
      enable_ghcr: false                                      # skip GHCR on PR
      enable_security_scan: false                             # skip Trivy on PR
      enable_base_update_detection: false                     # not used on PR
      enable_sonar_scan: true
      sonar_project_key: lferrarotti74_SpeedTest-Ookla
      sonar_organization: lferrarotti74
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Dummy PR validation for Dependabot (no SonarQube)
  pr-validate-dependabot:
    if: github.event_name == 'pull_request' && github.actor == 'dependabot[bot]'
    uses: lferrarotti74/github-workflows-templates/.github/workflows/build-extended.yml@25ec21c085efd79c053b177423a4ff2bbdc36bb1
    with:
      image_name: speedtest-ookla
      arch_list: linux/amd64
      enable_push: false
      env_file_path: env/.env
      version_var_name: SPEEDTEST_VERSION
      enable_ghcr: false
      enable_security_scan: false
      enable_base_update_detection: false
      enable_sonar_scan: false
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
